/*!
 * ZUI - v1.3.2 - 2016-01-14
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2016 cnezsoft.com; Licensed MIT
 */

!function(a){"use strict";var t="zui.datatable",e=(a.zui.store,function(e,s){this.name=t,this.$=a(e),this.isTable="TABLE"===this.$[0].tagName,this.firstShow=!0,this.isTable?(this.$table=this.$,this.id="datatable-"+(this.$.attr("id")||a.zui.uuid())):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+a.zui.uuid(),this.$.attr("id",this.id))),this.getOptions(s),this.load(),this.callEvent("ready")});e.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",checkboxName:null,sortable:!1,storage:!0,fixedHeader:!0,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,scrollPos:"in",rowHover:!0,colHover:!0,hoverClass:"hover",colHoverClass:"col-hover",mergeRows:!1,minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},e.prototype.getOptions=function(t){var s=this.$;t=a.extend({},e.DEFAULTS,this.$.data(),t),t.tableClass=t.tableClass||"",t.tableClass=" "+t.tableClass+" table-datatable",a.each(["bordered","condensed","striped","condensed","fixed"],function(a,e){e="table-"+e,s.hasClass(e)&&(t.tableClass+=" "+e)}),(s.hasClass("table-hover")||t.rowHover)&&(t.tableClass+=" table-hover"),this.options=t},e.prototype.load=function(e){var s,l=this.options;if(a.isPlainObject(e))this.data=e;else if("string"==typeof e){var d=a(e);d.length&&(this.$table=d.first(),this.$table.data(t,this),this.isTable=!0),e=null}else e=l.data;if(!e){if(!this.isTable)throw new Error("No data avaliable!");e={cols:[],rows:[]},s=e.cols;var i,r,o,n,h,c,f=e.rows,p=this.$table;p.find("thead > tr:first").children("th").each(function(){r=a(this),s.push(a.extend({text:r.html(),flex:r.hasClass("flex-col"),width:"auto",cssClass:r.attr("class"),css:r.attr("style"),type:"string",ignore:r.hasClass("ignore"),sort:!r.hasClass("sort-disabled"),mergeRows:r.attr("merge-rows")},r.data()))}),p.find("tbody > tr").each(function(){o=a(this),h=a.extend({data:[],checked:!1,cssClass:o.attr("class"),css:o.attr("style"),id:o.attr("id")},o.data()),o.children("td").each(function(){if(n=a(this),c=n.attr("colspan")||1,h.data.push(a.extend({cssClass:n.attr("class"),css:n.attr("style"),text:n.html(),colSpan:c,title:n.attr("title")},n.data())),c>1)for(i=1;c>i;i++)h.data.push({empty:!0})}),f.push(h)});var b=p.find("tfoot");b.length&&(e.footer=a('<table class="table'+l.tableClass+'"></table>').append(b))}e.flexStart=-1,e.flexEnd=-1,s=e.cols,e.colsLength=s.length;for(var i=0;i<e.colsLength;++i){var g=s[i];g.flex&&(e.flexStart<0&&(e.flexStart=i),e.flexEnd=i)}0===e.flexStart&&e.flexEnd===e.colsLength&&(e.flexStart=-1,e.flexEnd=-1),e.flexArea=e.flexStart>=0,e.fixedRight=e.flexEnd>=0&&e.flexEnd<e.colsLength-1,e.fixedLeft=e.flexStart>0,e.flexStart<0&&e.flexEnd<0&&(e.fixedLeft=!0,e.flexStart=e.colsLength,e.flexEnd=e.colsLength),this.data=e,this.callEvent("afterLoad",{data:e}),this.render()},e.prototype.render=function(){var e,s,l,d,i=this,r=i.$datatable||(i.isTable?a('<div class="datatable" id="'+i.id+'"/>'):i.$datatable),o=i.options,n=i.data,h=i.data.cols,c=i.data.rows,f=o.checkable,p='<div class="datatable-rows-span datatable-span"><div class="datatable-wrapper"><table class="table"></table></div></div>',b='<div class="datatable-head-span datatable-span"><div class="datatable-wrapper"><table class="table"><thead></thead></table></div></div>';r.children(".datatable-head, .datatable-rows, .scroll-wrapper").remove(),r.toggleClass("sortable",o.sortable);var g,v,x,C=a('<div class="datatable-head"/>');for(e=a("<tr/>"),l=a("<tr/>"),d=a("<tr/>"),s=0;s<h.length;s++)x=h[s],g=s<n.flexStart?e:s>=n.flexStart&&s<=n.flexEnd?d:l,0===s&&f&&g.append('<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'),x.ignore||(v=a("<th/>"),v.toggleClass("sort-down","down"===x.sort).toggleClass("sort-up","up"===x.sort).toggleClass("sort-disabled",x.sort===!1),v.addClass(x.cssClass).addClass(x.colClass).html(x.text).attr({"data-index":s,"data-type":x.type,style:x.css}),g.append(v));var u;n.fixedLeft&&(u=a(b),u.addClass("fixed-left").find("table").addClass(o.tableClass).find("thead").append(e),C.append(u)),n.flexArea&&(u=a(b),u.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(o.tableClass).find("thead").append(d),C.append(u)),n.fixedRight&&(u=a(b),u.addClass("fixed-right").find("table").addClass(o.tableClass).find("thead").append(l),C.append(u)),r.append(C);var w,k,m,y,$,S,E,L,A=a('<div class="datatable-rows">'),H=c.length;e=a("<tbody/>"),l=a("<tbody/>"),d=a("<tbody/>");for(var R=0;H>R;++R){for(S=c[R],"undefined"==typeof S.id&&(S.id=R),S.index=R,w=a("<tr/>"),w.addClass(S.cssClass).toggleClass(o.checkedClass,S.checked).attr({"data-index":R,"data-id":S.id}),k=w.clone(),m=w.clone(),L=S.data.length,s=0;L>s;++s)E=S.data[s],s>0&&E.empty||(g=s<n.flexStart?w:s>=n.flexStart&&s<=n.flexEnd?k:m,0===s&&f&&($=a('<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'),o.checkboxName&&$.append('<input class="hide" type="checkbox" name="'+o.checkboxName+'" value="'+S.id+'">'),g.append($)),h[s].ignore||(a.isPlainObject(E)?(E.row=R,E.index=s):E={text:E,row:R,index:s},S.data[s]=E,y=a("<td/>"),y.html(E.text).addClass(E.cssClass).addClass(h[s].colClass).attr("colspan",E.colSpan).attr({"data-row":R,"data-index":s,"data-flex":!1,"data-type":h[s].type,style:E.css,title:E.title||""}),g.append(y)));e.append(w),d.append(k),l.append(m)}var z;n.fixedLeft&&(z=a(p),z.addClass("fixed-left").find("table").addClass(o.tableClass).append(e),A.append(z)),n.flexArea&&(z=a(p),z.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(o.tableClass).append(d),A.append(z)),n.fixedRight&&(z=a(p),z.addClass("fixed-right").find("table").addClass(o.tableClass).append(l),A.append(z)),r.append(A),n.flexArea&&r.append('<div class="scroll-wrapper"><div class="scroll-slide scroll-pos-'+o.scrollPos+'"><div class="bar"></div></div></div>');var T=r.children(".datatable-footer").detach();n.footer?(r.append(a('<div class="datatable-footer"/>').append(n.footer)),n.footer=null):T.length&&r.append(T),i.$datatable=r.data(t,i),i.isTable&&i.firstShow&&(i.$table.attr("data-datatable-id",this.id).hide().after(r),i.firstShow=!1),i.bindEvents(),i.refreshSize(),i.callEvent("render")},e.prototype.bindEvents=function(){var t=this,e=this.data,s=this.options,l=a.zui.store,d=this.$datatable,i=t.$dataSpans=d.children(".datatable-head, .datatable-rows").find(".datatable-span"),r=t.$rowsSpans=d.children(".datatable-rows").children(".datatable-rows-span"),o=t.$headSpans=d.children(".datatable-head").children(".datatable-head-span"),n=t.$cells=i.find("td, th"),h=t.$dataCells=n.filter("td");t.$headCells=n.filter("th");var c=t.$rows=t.$rowsSpans.find(".table > tbody > tr");if(s.rowHover){var f=s.hoverClass;r.on("mouseenter","td",function(){h.filter("."+f).removeClass(f),c.filter("."+f).removeClass(f),c.filter('[data-index="'+a(this).addClass(f).closest("tr").data("index")+'"]').addClass(f)}).on("mouseleave","td",function(){h.filter("."+f).removeClass(f),c.filter("."+f).removeClass(f)})}if(s.colHover){var p=s.colHoverClass;o.on("mouseenter","th",function(){n.filter("."+p).removeClass(p),n.filter('[data-index="'+a(this).data("index")+'"]').addClass(p)}).on("mouseleave","th",function(){n.filter("."+p).removeClass(p)})}if(e.flexArea){var b,g,v,x,C,u,w,k=d.find(".scroll-slide"),m=d.find(".datatable-span.flexarea"),y=d.find(".datatable-span.fixed-left"),$=d.find(".datatable-span.flexarea .table"),S=k.children(".bar"),E=t.id+"_scrollOffset";t.width=d.width(),d.resize(function(){t.width=d.width()});var L=function(a,t){C=Math.max(0,Math.min(b-g,a)),t||d.addClass("scrolling"),S.css("left",C),w=0-Math.floor((v-b)*C/(b-g)),$.css("left",w),x=C,d.toggleClass("scrolled-in",C>2).toggleClass("scrolled-out",b-g-2>C),s.storage&&l.pageSet(E,C)},A=function(){b=m.width(),k.width(b).css("left",y.width()),v=$.width(),g=Math.floor(b*b/v),S.css("width",g),$.css("min-width",b),d.toggleClass("show-scroll-slide",v>b),u||b===g||(u=!0,L(l.pageGet(E,0),!0)),d.hasClass("size-changing")&&L(C,!0)};m.resize(A),s.storage&&A();var H={move:!1,stopPropagation:!0,drag:function(a){L(S.position().left+a.smallOffset.x*(a.element.hasClass("bar")?1:-1))},finish:function(){d.removeClass("scrolling")}};S.draggable(H),s.flexHeadDrag&&d.find(".datatable-head-span.flexarea").draggable(H),k.mousedown(function(a){var t=a.pageX-k.offset().left;L(t-g/2)})}if(s.checkable){var R,z=t.id+"_checkedStatus",T=s.checkedClass,N=function(){var d=r.first().find(".table > tbody > tr"),i=d.filter("."+T);d.find(".check-row input:checkbox").prop("checked",!1);var n={checkedAll:d.length===i.length&&i.length>0,checks:i.map(function(){return R=a(this).data("id"),s.checkboxName&&a(this).find(".check-row input:checkbox").prop("checked",!0),R}).toArray()};a.each(e.rows,function(t,e){e.checked=a.inArray(e.id,n.checks)>-1}),o.find(".check-all").toggleClass("checked",n.checkedAll),s.storage&&l.pageSet(z,n),t.callEvent("checksChanged",{checks:n})};this.$rowsSpans.on("click",s.checkByClickRow?"tr":".check-row",function(){c.filter('[data-index="'+a(this).closest("tr").data("index")+'"]').toggleClass(T),N()});var O="click.zui.datatable.check-all";if(this.$datatable.off(O).on(O,".check-all",function(){c.toggleClass(T,a(this).toggleClass("checked").hasClass("checked")),N()}).on("click",".check-none",function(){c.toggleClass(T,!1),N()}).on("click",".check-inverse",function(){c.toggleClass(T),N()}),s.storage){var W=l.pageGet(z);W&&(o.find(".check-all").toggleClass("checked",W.checkedAll),W.checkedAll?c.addClass(T):(c.removeClass(T),a.each(W.checks,function(a,t){c.filter('[data-id="'+t+'"]').addClass(T)})),W.checks.length&&N())}}if(s.fixedHeader){var F,D,M,P=d.children(".datatable-head"),j=s.fixedHeaderOffset||a(".navbar.navbar-fixed-top").height()||0,B=function(){F=d.offset().top,M=a(window).scrollTop(),D=d.height(),d.toggleClass("head-fixed",M+j>F&&F+D>M+j),d.hasClass("head-fixed")?P.css({width:d.width(),top:j}):P.attr("style","")};a(window).scroll(B),B()}s.sortable?(o.on("click","th:not(.sort-disabled, .check-btn)",function(){d.hasClass("size-changing")||t.sortTable(a(this))}),s.storage&&t.sortTable()):s.mergeRows&&this.mergeRows()},e.prototype.mergeRows=function(){for(var t=this.$rowsSpans.find(".table > tbody > tr > td"),e=this.data.cols,s=0;s<e.length;s++){var l=e[s];if(l.mergeRows){var d=t.filter('[data-index="'+s+'"]');if(d.length>1){var i,r;d.each(function(){var t=a(this);i&&t.html()===i.html()?(r=i.attr("rowspan")||1,"number"!=typeof r&&(r=parseInt(r),isNaN(r)&&(r=1)),i.attr("rowspan",r+1).css("vertical-align","middle"),t.remove()):i=t})}}}},e.prototype.sortTable=function(t){var e=a.zui.store,s=this.options,l=this.id+"_datatableSorter",d=s.storage?e.pageGet(l):null;if(t||(t=d?this.$headCells.filter('[data-index="'+d.index+'"]').addClass("sort-"+d.type):this.$headCells.filter(".sort-up, .sort-down").first()),t.length){var i,r,o,n=this.data,h=n.cols,c=n.rows,f=this.$headCells;i=!t.hasClass("sort-up"),f.removeClass("sort-up sort-down"),t.addClass(i?"sort-up":"sort-down"),o=t.data("index"),i=t.hasClass("sort-up"),a.each(h,function(a,t){a==o||"up"!==t.sort&&"down"!==t.sort?a==o&&(t.sort=i?"up":"down",r=t.type):t.sort=!0});var p,b,g,v=this.$dataCells.filter('[data-index="'+o+'"]');c.sort(function(a,t){return a=a.data[o],t=t.data[o],p=v.filter('[data-row="'+a.row+'"]').text(),b=v.filter('[data-row="'+t.row+'"]').text(),"number"===r?(p=parseFloat(p),b=parseFloat(b)):"date"===r?(p=Date.parse(p),b=Date.parse(b)):(p=p.toLowerCase(),b=b.toLowerCase()),g=p>b?1:b>p?-1:0,i&&(g=-1*g),g});var x,C,u,w=this.$rows,k=[];a.each(c,function(t,e){x=w.filter('[data-index="'+e.index+'"]'),x.each(function(t){u=a(this),C=k[t],C?C.after(u):u.parent().prepend(u),k[t]=u})}),d={index:o,type:i?"up":"down"},s.storage&&e.pageSet(l,d),this.callEvent("sort",{sorter:d})}},e.prototype.refreshSize=function(){var t,e=this.$datatable,s=this.options,l=this.data.rows,d=this.data.cols;e.find(".datatable-span.fixed-left").css("width",s.fixedLeftWidth),e.find(".datatable-span.fixed-right").css("width",s.fixedRightWidth);var i=function(t){var e,s,l=0;return t.css("height","auto"),t.each(function(){e=a(this),s=e.attr("rowspan"),s&&1!=s||(l=Math.max(l,e.outerHeight()))}),l},r=this.$dataCells,o=this.$cells,n=this.$headCells;for(t=0;t<d.length;++t)o.filter('[data-index="'+t+'"]').css("width",d[t].width);var h=i(n);n.css("min-height",h).css("height",h);var c;for(t=0;t<l.length;++t){c=r.filter('[data-row="'+t+'"]');var f=i(c);c.css("min-height",f).css("height",f)}},e.prototype.callEvent=function(a,t){var e=this.$.callEvent(a+"."+this.name,t,this).result;return!(void 0!==e&&!e)},a.fn.datatable=function(s,l){return this.each(function(){var d=a(this),i=d.data(t),r="object"==typeof s&&s;i||d.data(t,i=new e(this,r)),"string"==typeof s&&i[s](l)})},a.fn.datatable.Constructor=e}(jQuery);