/*!
 * ZUI - v1.2.0 - 2014-10-29
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

+function(a,b){"use strict";var c="zui.datatable",d=function(b,d){this.name=c,this.$=a(b),this.isTable="TABLE"===this.$[0].tagName,this.isTable?this.id="datatable-"+(this.$.attr("id")||a.uuid()):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+a.uuid(),this.$.attr("id",this.id))),this.getOptions(d),this.load(),this.render()};d.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",sortable:!1,fixedHeader:!0,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,rowHover:!0,colHover:!0,customizable:!1,minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},d.prototype.getOptions=function(b){var c=this.$,b=a.extend({},d.DEFAULTS,this.$.data(),b);b.tableClass=b.tableClass||"",b.tableClass=" "+b.tableClass+" table-datatable",c.hasClass("table-bordered")&&(b.tableClass+=" table-bordered"),(c.hasClass("table-hover")||b.rowHover)&&(b.tableClass+=" table-hover"),c.hasClass("table-striped")&&(b.tableClass+=" table-striped"),c.hasClass("table-condensed")&&(b.tableClass+=" table-condensed"),c.hasClass("table-fixed")&&(b.tableClass+=" table-fixed"),this.options=b},d.prototype.load=function(){var b=this.options.data,c=this.options,d=this.$;if(!b){if(!this.isTable)throw new Error("No data avaliable!");b={cols:[],rows:[]};var e,f,g,h,i=b.cols,j=b.rows;d.find("thead > tr:first").children("th").each(function(){e=a(this),i.push(a.extend({text:e.html(),flex:!1||e.hasClass("flex-col"),width:"auto",cssClass:e.attr("class"),css:e.attr("style"),type:"string",sort:!e.hasClass("sort-disabled")},e.data()))}),d.find("tbody > tr").each(function(){f=a(this),h=a.extend({data:[],checked:!1,cssClass:f.attr("class"),css:f.attr("style"),id:f.attr("id")},f.data()),f.children("td").each(function(){g=a(this),h.data.push(a.extend({cssClass:g.attr("class"),css:g.attr("style"),text:g.html()},g.data()))}),j.push(h)});var k=d.find("tfoot");k.length&&(b.footer=a('<table class="table'+c.tableClass+'"></table>').append(k))}b.flexStart=-1,b.flexEnd=-1;var i=b.cols;b.colsLength=i.length;for(var l=0;l<i.length;++l){var m=i[l];m.flex&&(b.flexStart<0&&(b.flexStart=l),b.flexEnd=l)}0===b.flexStart&&b.flexEnd===i.length&&(b.flexStart=-1,b.flexEnd=-1),b.flexArea=b.flexStart>=0,b.fixedRight=b.flexEnd>=0&&b.flexEnd<i.length-1,b.fixedLeft=b.flexStart>0,b.flexStart<0&&b.flexEnd<0&&(b.fixedLeft=!0,b.flexStart=i.length,b.flexEnd=i.length),this.data=b,this.callEvent("afterLoad",{data:b})},d.prototype.html=function(){var b=!a("#"+this.id).empty().length,c="",d=this.options,e=this.data,f=this.data.cols,g="",h="",i="",j=this.data.rows,k='<div class="datatable-rows-span datatable-span {0}"><div class="datatable-wrapper"><table class="table'+d.tableClass+'"><tbody>{1}</tbody></table>{2}</div></div>',l='<div class="datatable-head-span datatable-span {0}"><div class="datatable-wrapper"><table class="table'+d.tableClass+'"><thead><tr>{1}</tr></thead></table>{2}</div></div>';b?c+='<div class="datatable'+(d.sortable?" sortable":"")+" "+(d.customizable?" customizable":"")+'" id="'+this.id+'">':this.$datatable.toggleClass("sortable",d.sortable).toggleClass("customizable",d.customizable),c+='<div class="datatable-head">';for(var m,n,o,p=0;p<f.length;p++)n=f[p],o="","undefined"==typeof n.customizable&&(n.customizable=!0),"undefined"==typeof n.sort?n.sort=!0:"down"===n.sort?o="sort-down":"up"===n.sort?o="sort-up":n.sort===!1&&(o="sort-disabled"),m='<th class="'+(n.cssClass||"")+" "+(n.colClass||"")+" "+o+'" data-index="'+p+'" data-type="'+n.type+'" style="'+n.css+'">'+n.text+(n.customizable&&p!=e.flexStart-1&&p!=e.flexEnd&&p<f.length-1?'<div class="size-handle"></div>':"")+"</th>",0==p&&d.checkable&&(m='<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'+m),p<e.flexStart?g+=m:p>=e.flexStart&&p<=e.flexEnd?i+=m:p>e.flexEnd&&(h+=m);e.fixedLeft&&(c+=l.format("fixed-left",g,'<div class="size-handle size-handle-head size-handle-left"></div>')),e.flexArea&&(c+=l.format("flexarea",i,'<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>')),e.fixedRight&&(c+=l.format("fixed-right",h,'<div class="size-handle size-handle-head size-handle-right"></div>')),c+="</div>",c+='<div class="datatable-rows">';var q,r,p,s,t,u;g="",h="",i="";for(var v=0;v<j.length;++v){for(r=j[v],t=r.cssClass||"",r.checked&&(t+=" "+(d.checkedClass||"")),"undefined"==typeof r.id&&(r.id=v),r.index=v,q='<tr class="'+t+'" data-index="'+v+'" data-id="'+r.id+'">',g+=q,h+=q,i+=q,p=0;p<r.data.length;++p)u=r.data[p],a.isPlainObject(u)||(u={text:u,row:v,index:p},r.data[p]=u),s='<td data-row="'+v+'" data-index="'+p+'" data-flex="false" data-type="'+f[p].type+'" class="'+(u.cssClass||"")+" "+(f[p].colClass||"")+'" style="'+(u.css||"")+'">'+u.text+"</td>",0==p&&d.checkable&&(s='<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'+s),p<e.flexStart?g+=s:p>=e.flexStart&&p<=e.flexEnd?i+=s:p>e.flexEnd&&(h+=s);g+="</tr>",h+="</tr>",i+="</tr>"}return e.fixedLeft&&(c+=k.format("fixed-left",g,"")),e.flexArea&&(c+=k.format("flexarea",i,'<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div><div class="scroll-slide"><div class="bar"></div></div>')),e.fixedRight&&(c+=k.format("fixed-right",h,"")),c+="</div>",e.footer&&(c+='<div class="datatable-footer">',c+="</div>"),b&&(c+="</div>"),c},d.prototype.render=function(){this.isTable?(this.$.attr("data-datatable-id",this.id).hide(),this.$.after(this.html()),this.$datatable=a("#"+this.id)):this.$.html(this.html()),this.data.footer&&this.$datatable.children(".datatable-footer").empty().append(this.data.footer),this.$dataSpans=this.$datatable.children(".datatable-head, .datatable-rows").find(".datatable-span"),this.$rowsSpans=this.$datatable.children(".datatable-rows").children(".datatable-rows-span"),this.$headSpans=this.$datatable.children(".datatable-head").children(".datatable-head-span"),this.$cells=this.$dataSpans.find("td, th"),this.$dataCells=this.$cells.filter("td"),this.$headCells=this.$cells.filter("th"),this.$rows=this.$rowsSpans.find(".table > tbody > tr");var c=this.options,d=this,e=this.data,f=this.$cells,g=this.$dataCells,h=(this.$headCells,this.$datatable);if(c.rowHover){var i="hover";this.$rowsSpans.on("mouseenter","td",function(){g.filter("."+i).removeClass(i),d.$rows.filter("."+i).removeClass(i),d.$rows.filter('[data-index="'+a(this).addClass(i).closest("tr").data("index")+'"]').addClass(i)}).on("mouseleave","td",function(){g.filter("."+i).removeClass(i),d.$rows.filter("."+i).removeClass(i)})}if(c.colHover){var j="col-hover";this.$headSpans.on("mouseenter","th",function(){f.filter("."+j).removeClass(j),f.filter('[data-index="'+a(this).data("index")+'"]').addClass(j)}).on("mouseleave","th",function(){f.filter("."+j).removeClass(j)})}if(this.data.flexArea){var k,l,m,n,o,p,q,r=h.find(".scroll-slide"),s=h.find(".datatable-span.flexarea .table"),t=h.find(".datatable-rows-span.flexarea .table"),u=r.children(".bar"),v=d.id+"_scrollOffset";this.width=h.width(),h.resize(function(){d.width=h.width()});var w=function(a,b){o=Math.max(0,Math.min(k-l,a)),b||h.addClass("scrolling"),u.css("left",o),q=0-Math.floor((m-k)*o/(k-l)),s.css("left",q),n=o,h.toggleClass("scrolled-in",o>2).toggleClass("scrolled-out",k-l-2>o),store.pageSet(v,o)},x=function(){k=r.width(),m=t.width(),l=Math.floor(k*k/m),u.css("width",l),t.css("min-width",k),h.toggleClass("show-scroll-slide",m>k),p||k===l||(p=!0,w(store.pageGet(v,0),!0)),h.hasClass("size-changing")&&w(o,!0)};r.resize(x),t.resize(x),x();var y={move:!1,stopPropagation:!0,drag:function(a){w(u.position().left+a.smallOffset.x*(a.element.hasClass("bar")?1:-1))},finish:function(){h.removeClass("scrolling")}};u.draggable(y),c.flexHeadDrag&&h.find(".datatable-head-span.flexarea").draggable(y),r.mousedown(function(a){var b=a.pageX-r.offset().left;w(b-l/2)})}if(c.checkable){var z,A=d.id+"_checkedStatus",B=c.checkedClass,C=function(){var b=d.$rowsSpans.first().find(".table > tbody > tr"),c=b.filter("."+B),f={checkedAll:b.length===c.length&&c.length>0,checks:c.map(function(){return z=a(this).data("id")}).toArray()};a.each(e.rows,function(b,c){c.checked=a.inArray(c.id,f.checks)>-1}),d.$headSpans.find(".check-all").toggleClass("checked",f.checkedAll),store.pageSet(A,f),d.callEvent("checksChanged",{checks:f})};this.$rowsSpans.on("click",c.checkByClickRow?"tr":".check-row",function(){d.$rows.filter('[data-index="'+a(this).closest("tr").data("index")+'"]').toggleClass(B),C()}),this.$datatable.on("click",".check-all",function(){d.$rows.toggleClass(B,a(this).toggleClass("checked").hasClass("checked")),C()}).on("click",".check-none",function(){d.$rows.toggleClass(B,!1),C()}).on("click",".check-inverse",function(){d.$rows.toggleClass(B),C()});var D=store.pageGet(A);D&&(this.$headSpans.find(".check-all").toggleClass("checked",D.checkedAll),D.checkedAll?d.$rows.addClass(B):(d.$rows.removeClass(B),a.each(D.checks,function(a,b){d.$rows.filter('[data-id="'+b+'"]').addClass(B)})),D.checks.length&&d.callEvent("checksChanged",{checks:D}))}if(c.fixedHeader){var E,F,G,H=h.children(".datatable-head"),I=c.fixedHeaderOffset||a(".navbar.navbar-fixed-top").height()||0,J=function(){E=h.offset().top,G=a(b).scrollTop(),F=h.height(),h.toggleClass("head-fixed",G+I>E&&E+F>G+I),h.hasClass("head-fixed")?H.css({width:h.width(),top:I}):H.attr("style","")};a(b).scroll(J),J()}if(c.sortable){var K;this.$headSpans.on("click","th:not(.sort-disabled, .check-btn)",function(){h.hasClass("size-changing")||d.sortTable(a(this))})}if(c.customizable){var L,K,M,N,O=this.$headSpans.find(".size-handle"),P=function(a,b){var f={};a.hasClass("size-handle-head")?(L=a.closest(".datatable-head-span").width(),a.hasClass("size-handle-left")?(f.change="fixedLeftWidth",f.oldWidth=d.fixedLeftWidth,d.fixedLeftWidth=Math.min(d.width-(d.fixedRightWidth||d.$headSpans.filter(".fixed-right").width())-c.minFlexAreaWidth,Math.max(c.minFixedLeftWidth,L+b)),f.newWidth=d.fixedLeftWidth):(f.change="fixedRightWidth",f.oldWidth=d.fixedRightWidth,d.fixedRightWidth=Math.min(d.width-(d.fixedLeftWidth||d.$headSpans.filter(".fixed-left").width())-c.minFlexAreaWidth,Math.max(c.minFixedRightWidth,L-b)),f.newWidth=d.fixedRightWidth)):(K=a.closest("th"),M=e.cols[K.data("index")],L=M.width,"auto"===L?(a=K.closest(".datatable-head-span"),L=a.width(),a.hasClass("fixed-left")?(f.change="fixedLeftWidth",f.oldWidth=d.fixedLeftWidth,d.fixedLeftWidth=Math.min(d.width-(d.fixedRightWidth||d.$headSpans.filter(".fixed-right").width())-c.minFlexAreaWidth,Math.max(c.minFixedLeftWidth,L+b)),f.newWidth=d.fixedLeftWidth):a.hasClass("fixed-right")&&(f.change="fixedRightWidth",f.oldWidth=d.fixedRightWidth,d.fixedRightWidth=Math.min(d.width-(d.fixedLeftWidth||d.$headSpans.filter(".fixed-left").width())-c.minFlexAreaWidth,Math.max(c.minFixedRightWidth,L-b)),f.newWidth=d.fixedRightWidth)):(f.change="colWidth",f.oldWidth=M.width,f.colIndex=M.index,M.width=Math.max(c.minColWidth,L+b),f.newWidth=M.width)),d.refreshSize(),d.callEvent("sizeChanged",{changes:f})};O.draggable({move:!1,stopPropagation:!0,before:function(){N=null,h.addClass("size-changing")},drag:function(a){P(a.element,a.smallOffset.x)},finish:function(){h.removeClass("size-changing")}})}this.refresh(),this.callEvent("ready")},d.prototype.sortTable=function(b){var c=self.id+"_datatableSorter",d=store.pageGet(c);if(b||(b=d?this.$headCells.filter('[data-index="'+d.index+'"]').addClass("sort-"+d.type):this.$headCells.filter(".sort-up, .sort-down").first()),b.length){var e,f,g,h=this.data,i=h.cols,j=h.rows,k=this.$headCells;e=!b.hasClass("sort-up"),k.removeClass("sort-up sort-down"),b.addClass(e?"sort-up":"sort-down"),g=b.data("index"),e=b.hasClass("sort-up"),a.each(i,function(a,b){a==g||"up"!==b.sort&&"down"!==b.sort?a==g&&(b.sort=e?"up":"down",f=b.type):b.sort=!0});var l,m,n,o=this.$dataCells.filter('[data-index="'+g+'"]');j.sort(function(a,b){return a=a.data[g],b=b.data[g],l=o.filter('[data-row="'+a.row+'"]').text(),m=o.filter('[data-row="'+b.row+'"]').text(),"number"===f?(l=parseFloat(l),m=parseFloat(m)):"date"===f?(l=Date.parse(l),m=Date.parse(m)):(l=l.toLowerCase(),m=m.toLowerCase()),n=l>m?1:m>l?-1:0,e&&(n=-1*n),n});var p,q,r,s=this.$rows,t=[];a.each(j,function(b,c){p=s.filter('[data-index="'+c.index+'"]'),p.each(function(b){r=a(this),q=t[b],q?q.after(r):r.parent().prepend(r),t[b]=r})});var d={index:g,type:e?"up":"down"};store.pageSet(c,d),this.callEvent("sort",{sorter:d})}},d.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this).result;return!(void 0!=c&&!c)},d.prototype.refreshSize=function(){var b=this.$datatable,c=this.options,d=this.data.rows,e=this.data.cols;b.find(".datatable-span.fixed-left").css("width",this.fixedLeftWidth||c.fixedLeftWidth),b.find(".datatable-span.fixed-right").css("width",this.fixedRightWidth||c.fixedRightWidth);for(var f=function(b){var c=0;return b.css("height","auto"),b.each(function(){c=Math.max(c,a(this).height())}),c},g=this.$dataCells,h=this.$cells,i=this.$headCells,j=0;j<e.length;++j)h.filter('[data-index="'+j+'"]').css("width",e[j].width);i.height(f(i));for(var k,j=0;j<d.length;++j)k=g.filter('[data-row="'+j+'"]'),k.height(f(k))},d.prototype.refresh=function(){this.refreshSize(),this.sortTable()},a.fn.datatable=function(b){return this.each(function(){var e=a(this),f=e.data(c),g="object"==typeof b&&b;f||e.data(c,f=new d(this,g)),"string"==typeof b&&f[b]()})},a.fn.datatable.Constructor=d}(jQuery,window);