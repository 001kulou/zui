/*!
 * ZUI - v1.2.0-beta - 2014-10-31
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2014 cnezsoft.com; Licensed MIT
 */

!function(a){"use strict";var b="zui.datatable",c=function(c,d){this.name=b,this.$=a(c),this.isTable="TABLE"===this.$[0].tagName,this.isTable?this.id="datatable-"+(this.$.attr("id")||a.uuid()):(this.$datatable=this.$.addClass("datatable"),this.$.attr("id")?this.id=this.$.attr("id"):(this.id="datatable-"+a.uuid(),this.$.attr("id",this.id))),this.getOptions(d),this.load(),this.callEvent("ready")};c.DEFAULTS={checkable:!1,checkByClickRow:!0,checkedClass:"active",sortable:!1,fixedHeader:!0,fixedHeaderOffset:0,fixedLeftWidth:"30%",fixedRightWidth:"30%",flexHeadDrag:!0,scrollPos:"in",rowHover:!0,colHover:!0,hoverClass:"hover",colHoverClass:"col-hover",minColWidth:20,minFixedLeftWidth:200,minFixedRightWidth:200,minFlexAreaWidth:200},c.prototype.getOptions=function(b){var d=this.$;b=a.extend({},c.DEFAULTS,this.$.data(),b),b.tableClass=b.tableClass||"",b.tableClass=" "+b.tableClass+" table-datatable",d.hasClass("table-bordered")&&(b.tableClass+=" table-bordered"),(d.hasClass("table-hover")||b.rowHover)&&(b.tableClass+=" table-hover"),d.hasClass("table-striped")&&(b.tableClass+=" table-striped"),d.hasClass("table-condensed")&&(b.tableClass+=" table-condensed"),d.hasClass("table-fixed")&&(b.tableClass+=" table-fixed"),this.options=b},c.prototype.load=function(b){var c,d=this.options,e=this.$;if(b=b||d.data,!b){if(!this.isTable)throw new Error("No data avaliable!");b={cols:[],rows:[]},c=b.cols;var f,g,h,i,j=b.rows;e.find("thead > tr:first").children("th").each(function(){f=a(this),c.push(a.extend({text:f.html(),flex:!1||f.hasClass("flex-col"),width:"auto",cssClass:f.attr("class"),css:f.attr("style"),type:"string",sort:!f.hasClass("sort-disabled")},f.data()))}),e.find("tbody > tr").each(function(){g=a(this),i=a.extend({data:[],checked:!1,cssClass:g.attr("class"),css:g.attr("style"),id:g.attr("id")},g.data()),g.children("td").each(function(){h=a(this),i.data.push(a.extend({cssClass:h.attr("class"),css:h.attr("style"),text:h.html()},h.data()))}),j.push(i)});var k=e.find("tfoot");k.length&&(b.footer=a('<table class="table'+d.tableClass+'"></table>').append(k))}b.flexStart=-1,b.flexEnd=-1,c=b.cols,b.colsLength=c.length;for(var l=0;l<b.colsLength;++l){var m=c[l];m.flex&&(b.flexStart<0&&(b.flexStart=l),b.flexEnd=l)}0===b.flexStart&&b.flexEnd===b.colsLength&&(b.flexStart=-1,b.flexEnd=-1),b.flexArea=b.flexStart>=0,b.fixedRight=b.flexEnd>=0&&b.flexEnd<b.colsLength-1,b.fixedLeft=b.flexStart>0,b.flexStart<0&&b.flexEnd<0&&(b.fixedLeft=!0,b.flexStart=b.colsLength,b.flexEnd=b.colsLength),this.data=b,this.callEvent("afterLoad",{data:b}),this.render()},c.prototype.render=function(){var b,c,d,e,f=this,g=f.$datatable||(f.isTable?a('<div class="datatable" id="'+f.id+'"/>'):f.$datatable),h=f.options,i=f.data,j=f.data.cols,k=f.data.rows,l=h.checkable,m='<div class="datatable-rows-span datatable-span"><div class="datatable-wrapper"><table class="table"></table></div></div>',n='<div class="datatable-head-span datatable-span"><div class="datatable-wrapper"><table class="table"><thead></thead></table></div></div>';g.empty(),g.toggleClass("sortable",h.sortable);var o,p,q,r=a('<div class="datatable-head"/>');for(b=a("<tr/>"),d=a("<tr/>"),e=a("<tr/>"),c=0;c<j.length;c++)q=j[c],o=c<i.flexStart?b:c>=i.flexStart&&c<=i.flexEnd?e:d,p=a("<th/>"),p.toggleClass("sort-down","down"===q.sort).toggleClass("sort-up","up"===q.sort).toggleClass("sort-disabled",q.sort===!1),p.addClass(q.cssClass).addClass(q.colClass).html(q.text).attr({"data-index":c,"data-type":q.type,style:q.css}),0===c&&l&&o.append('<th data-index="check" class="check-all check-btn"><i class="icon-check-empty"></i></th>'),o.append(p);var s;i.fixedLeft&&(s=a(n),s.addClass("fixed-left").find("table").addClass(h.tableClass).find("thead").append(b),r.append(s)),i.flexArea&&(s=a(n),s.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(h.tableClass).find("thead").append(e),r.append(s)),i.fixedRight&&(s=a(n),s.addClass("fixed-right").find("table").addClass(h.tableClass).find("thead").append(d),r.append(s)),g.append(r);var t,u,v,w,x,y,z,A=a('<div class="datatable-rows">'),B=k.length;b=a("<tbody/>"),d=a("<tbody/>"),e=a("<tbody/>");for(var C=0;B>C;++C){for(x=k[C],"undefined"==typeof x.id&&(x.id=C),x.index=C,t=a("<tr/>"),t.addClass(x.cssClass).toggleClass(h.checkedClass,x.checked).attr({"data-index":C,"data-id":x.id}),u=t.clone(),v=t.clone(),z=x.data.length,c=0;z>c;++c)y=x.data[c],o=c<i.flexStart?t:c>=i.flexStart&&c<=i.flexEnd?u:v,a.isPlainObject(y)||(y={text:y,row:C,index:c},x.data[c]=y),w=a("<td/>"),w.html(y.text).addClass(y.cssClass).addClass(j[c].colClass).attr({"data-row":C,"data-index":c,"data-flex":!1,"data-type":j[c].type,style:y.css}),0===c&&l&&o.append('<td data-index="check" class="check-row check-btn"><i class="icon-check-empty"></i></td>'),o.append(w);b.append(t),e.append(u),d.append(v)}var D;i.fixedLeft&&(D=a(m),D.addClass("fixed-left").find("table").addClass(h.tableClass).append(b),A.append(D)),i.flexArea&&(D=a(m),D.addClass("flexarea").find(".datatable-wrapper").append('<div class="scrolled-shadow scrolled-in-shadow"></div><div class="scrolled-shadow scrolled-out-shadow"></div>').find("table").addClass(h.tableClass).append(e),A.append(D)),i.fixedRight&&(D=a(m),D.addClass("fixed-right").find("table").addClass(h.tableClass).append(d),A.append(D)),g.append(A),i.flexArea&&g.append('<div class="scroll-wrapper"><div class="scroll-slide scroll-pos-'+h.scrollPos+'"><div class="bar"></div></div></div>'),i.footer&&g.append(a('<div class="datatable-footer"/>').append(i.footer)),f.$datatable=g,f.isTable&&f.$.attr("data-datatable-id",this.id).hide().after(g),f.bindEvents(),this.refreshSize(),this.callEvent("render")},c.prototype.bindEvents=function(){var b=this,c=this.data,d=this.options,e=window.store,f=this.$datatable,g=b.$dataSpans=f.children(".datatable-head, .datatable-rows").find(".datatable-span"),h=b.$rowsSpans=f.children(".datatable-rows").children(".datatable-rows-span"),i=b.$headSpans=f.children(".datatable-head").children(".datatable-head-span"),j=b.$cells=g.find("td, th"),k=b.$dataCells=j.filter("td");b.$headCells=j.filter("th");var l=b.$rows=b.$rowsSpans.find(".table > tbody > tr");if(d.rowHover){var m=d.hoverClass;h.on("mouseenter","td",function(){k.filter("."+m).removeClass(m),l.filter("."+m).removeClass(m),l.filter('[data-index="'+a(this).addClass(m).closest("tr").data("index")+'"]').addClass(m)}).on("mouseleave","td",function(){k.filter("."+m).removeClass(m),l.filter("."+m).removeClass(m)})}if(d.colHover){var n=d.colHoverClass;i.on("mouseenter","th",function(){j.filter("."+n).removeClass(n),j.filter('[data-index="'+a(this).data("index")+'"]').addClass(n)}).on("mouseleave","th",function(){j.filter("."+n).removeClass(n)})}if(c.flexArea){var o,p,q,r,s,t,u,v=f.find(".scroll-slide"),w=f.find(".datatable-span.flexarea"),x=f.find(".datatable-span.fixed-left"),y=f.find(".datatable-span.flexarea .table"),z=v.children(".bar"),A=b.id+"_scrollOffset";b.width=f.width(),f.resize(function(){b.width=f.width()});var B=function(a,b){s=Math.max(0,Math.min(o-p,a)),b||f.addClass("scrolling"),z.css("left",s),u=0-Math.floor((q-o)*s/(o-p)),y.css("left",u),r=s,f.toggleClass("scrolled-in",s>2).toggleClass("scrolled-out",o-p-2>s),e.pageSet(A,s)},C=function(){o=w.width(),v.width(o).css("left",x.width()),q=y.width(),p=Math.floor(o*o/q),z.css("width",p),y.css("min-width",o),f.toggleClass("show-scroll-slide",q>o),t||o===p||(t=!0,B(e.pageGet(A,0),!0)),f.hasClass("size-changing")&&B(s,!0)};v.resize(C),y.resize(C),C();var D={move:!1,stopPropagation:!0,drag:function(a){B(z.position().left+a.smallOffset.x*(a.element.hasClass("bar")?1:-1))},finish:function(){f.removeClass("scrolling")}};z.draggable(D),d.flexHeadDrag&&f.find(".datatable-head-span.flexarea").draggable(D),v.mousedown(function(a){var b=a.pageX-v.offset().left;B(b-p/2)})}if(d.checkable){var E,F=b.id+"_checkedStatus",G=d.checkedClass,H=function(){var d=h.first().find(".table > tbody > tr"),f=d.filter("."+G),g={checkedAll:d.length===f.length&&f.length>0,checks:f.map(function(){return E=a(this).data("id")}).toArray()};a.each(c.rows,function(b,c){c.checked=a.inArray(c.id,g.checks)>-1}),i.find(".check-all").toggleClass("checked",g.checkedAll),e.pageSet(F,g),b.callEvent("checksChanged",{checks:g})};this.$rowsSpans.on("click",d.checkByClickRow?"tr":".check-row",function(){l.filter('[data-index="'+a(this).closest("tr").data("index")+'"]').toggleClass(G),H()}),this.$datatable.on("click",".check-all",function(){l.toggleClass(G,a(this).toggleClass("checked").hasClass("checked")),H()}).on("click",".check-none",function(){l.toggleClass(G,!1),H()}).on("click",".check-inverse",function(){l.toggleClass(G),H()});var I=e.pageGet(F);I&&(i.find(".check-all").toggleClass("checked",I.checkedAll),I.checkedAll?l.addClass(G):(l.removeClass(G),a.each(I.checks,function(a,b){l.filter('[data-id="'+b+'"]').addClass(G)})),I.checks.length&&b.callEvent("checksChanged",{checks:I}))}d.sortable&&i.on("click","th:not(.sort-disabled, .check-btn)",function(){f.hasClass("size-changing")||b.sortTable(a(this))})},c.prototype.sortTable=function(b){var c=window.store,d=this.id+"_datatableSorter",e=c.pageGet(d);if(b||(b=e?this.$headCells.filter('[data-index="'+e.index+'"]').addClass("sort-"+e.type):this.$headCells.filter(".sort-up, .sort-down").first()),b.length){var f,g,h,i=this.data,j=i.cols,k=i.rows,l=this.$headCells;f=!b.hasClass("sort-up"),l.removeClass("sort-up sort-down"),b.addClass(f?"sort-up":"sort-down"),h=b.data("index"),f=b.hasClass("sort-up"),a.each(j,function(a,b){a==h||"up"!==b.sort&&"down"!==b.sort?a==h&&(b.sort=f?"up":"down",g=b.type):b.sort=!0});var m,n,o,p=this.$dataCells.filter('[data-index="'+h+'"]');k.sort(function(a,b){return a=a.data[h],b=b.data[h],m=p.filter('[data-row="'+a.row+'"]').text(),n=p.filter('[data-row="'+b.row+'"]').text(),"number"===g?(m=parseFloat(m),n=parseFloat(n)):"date"===g?(m=Date.parse(m),n=Date.parse(n)):(m=m.toLowerCase(),n=n.toLowerCase()),o=m>n?1:n>m?-1:0,f&&(o=-1*o),o});var q,r,s,t=this.$rows,u=[];a.each(k,function(b,c){q=t.filter('[data-index="'+c.index+'"]'),q.each(function(b){s=a(this),r=u[b],r?r.after(s):s.parent().prepend(s),u[b]=s})}),e={index:h,type:f?"up":"down"},c.pageSet(d,e),this.callEvent("sort",{sorter:e})}},c.prototype.refreshSize=function(){var b,c=this.$datatable,d=this.options,e=this.data.rows,f=this.data.cols;c.find(".datatable-span.fixed-left").css("width",d.fixedLeftWidth),c.find(".datatable-span.fixed-right").css("width",d.fixedRightWidth);var g=function(b){var c=0;return b.css("height","auto"),b.each(function(){c=Math.max(c,a(this).height())}),c},h=this.$dataCells,i=this.$cells,j=this.$headCells;for(b=0;b<f.length;++b)i.filter('[data-index="'+b+'"]').css("width",f[b].width);j.height(g(j));var k;for(b=0;b<e.length;++b)k=h.filter('[data-row="'+b+'"]'),k.height(g(k))},c.prototype.callEvent=function(a,b){var c=this.$.callEvent(a+"."+this.name,b,this).result;return!(void 0!==c&&!c)},a.fn.datatable=function(d){return this.each(function(){var e=a(this),f=e.data(b),g="object"==typeof d&&d;f||e.data(b,f=new c(this,g)),"string"==typeof d&&f[d]()})},a.fn.datatable.Constructor=c}(window.jQuery);