/*!
 * ZUI: 控制面板 - v1.5.0 - 2016-08-25
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2016 cnezsoft.com; Licensed MIT
 */
!function(e,a){"use strict";function n(e,n,t,i){return a.abs((t-e)*(i-n))}function t(e,a,n,t,i,s){return e>=n&&i>=e&&a>=t&&s>=a}function i(e,i,s,o,r,d,l,h){var p=a.max(e,r),g=a.max(i,d),c=a.min(s,l),f=a.min(o,h);return t(p,g,e,i,s,o)&&t(c,f,e,i,s,o)&&t(p,g,r,d,l,h)&&t(c,f,r,d,l,h)?n(p,g,c,f):0}var s=function(a,n){this.$=e(a),this.options=this.getOptions(n),this.draggable=this.$.hasClass("dashboard-draggable")||this.options.draggable,this.init()};s.DEFAULTS={height:360,shadowType:"normal",sensitive:!1,circleShadowSize:100,onlyRefreshBody:!0,resizable:!0,resizeMessage:!0},s.prototype.getOptions=function(a){return a=e.extend({},s.DEFAULTS,this.$.data(),a)},s.prototype.handleRemoveEvent=function(){var a=this.options.afterPanelRemoved,n=this.options.panelRemovingTip;this.$.on("click",".remove-panel",function(){var t=e(this).closest(".panel"),i=t.data("name")||t.find(".panel-heading").text().replace("\n","").replace(/(^\s*)|(\s*$)/g,""),s=t.attr("data-id");(void 0===n||confirm(n.format(i)))&&(t.parent().remove(),a&&e.isFunction(a)&&a(s))})},s.prototype.handleRefreshEvent=function(){var a=this,n=this.options.onlyRefreshBody;this.$.on("click",".refresh-panel",function(){var t=e(this).closest(".panel");a.refresh(t,n)})},s.prototype.handleDraggable=function(){var t=this.$,s=this.options,o="circle"===s.shadowType,r=s.circleShadowSize,d=r/2,l=s.afterOrdered;this.$.addClass("dashboard-draggable"),this.$.on("mousedown",".panel-actions, .drag-disabled",function(e){e.stopPropagation()});var h;this.$.on("mousedown",".panel-heading, .panel-drag-handler",function(p){function g(t){var o=P.data("mouseOffset");u=t.pageX-o.x,v=t.pageY-o.y,m=u+F,b=v+A,P.css({left:u,top:v}),T.find(".dragging-in").removeClass("dragging-in"),z=!1,C=null;var r,d=0;T.children(":not(.dragging-col)").each(function(){var o=e(this);if(o.hasClass("dragging-col-holder"))return z=!s.sensitive||100>d,!0;var l=o.children(".panel"),h=l.offset(),p=l.width(),g=l.height(),c=h.left,f=h.top;if(s.sensitive)c-=D.left,f-=D.top,r=i(u,v,m,b,c,f,c+p,f+g),r>100&&r>d&&r>a.min(n(u,v,m,b),n(c,f,c+p,f+g))/3&&(d=r,C=o);else{var y=t.pageX,w=t.pageY;if(y>c&&w>f&&c+p>y&&f+g>w)return C=o,!1}}),C&&(y&&clearTimeout(y),w=C,y=setTimeout(c,50)),t.preventDefault()}function c(){w&&(w.addClass("dragging-in"),z?E.insertAfter(w):E.insertBefore(w),t.addClass("dashboard-holding"),y=null,w=null)}function f(a){y&&clearTimeout(y);var n=$.data("order");$.parent().insertAfter(E);var i=0,s={};T.children(":not(.dragging-col-holder)").each(function(){var a=e(this).children(".panel");a.data("order",++i),s[a.data("id")||a.attr("id")]=i,a.parent().attr("data-order",i)}),n!=s[$.data("id")||$.attr("id")]&&(T.data("orders",s),l&&e.isFunction(l)&&l(s)),P.remove(),t.removeClass("dashboard-holding"),t.find(".dragging-col").removeClass("dragging-col"),t.find(".panel-dragging").removeClass("panel-dragging"),T.find(".dragging-in").removeClass("dragging-in"),t.removeClass("dashboard-dragging"),e(document).unbind("mousemove",g).unbind("mouseup",f),a.preventDefault()}var u,v,m,b,y,C,z,w,$=e(this).closest(".panel"),R=$.parent(),T=$.closest(".row"),P=$.clone().addClass("panel-dragging-shadow"),x=$.offset(),D=t.offset(),E=T.find(".dragging-col-holder"),F=$.width(),A=$.height();E.length||(E=e('<div class="dragging-col-holder"><div class="panel"></div></div>').removeClass("dragging-col").appendTo(T)),h&&E.removeClass(h),E.addClass(h=R.attr("class")),E.insertBefore(R).find(".panel").replaceWith($.clone().addClass("panel-dragging panel-dragging-holder")),t.addClass("dashboard-dragging"),$.addClass("panel-dragging").parent().addClass("dragging-col"),P.css({left:x.left-D.left,top:x.top-D.top,width:F,height:A}).appendTo(t).data("mouseOffset",{x:p.pageX-x.left+D.left,y:p.pageY-x.top+D.top}),o&&(P.addClass("circle"),setTimeout(function(){P.css({left:p.pageX-D.left-d,top:p.pageY-D.top-d,width:r,height:r}).data("mouseOffset",{x:D.left+d,y:D.top+d})},100)),e(document).bind("mousemove",g).bind("mouseup",f),p.preventDefault()})},s.prototype.handlePanelPadding=function(){this.$.find(".panel-body > table, .panel-body > .list-group").parent().addClass("no-padding")},s.prototype.handlePanelHeight=function(){var n=this.options.height;this.$.children(".row").each(function(){var t=e(this),i=t.find(".panel"),s=t.data("height")||n;"number"!=typeof s&&(s=0,i.each(function(){s=a.max(s,e(this).innerHeight())})),i.css("height",s)})},s.prototype.handleResizeEvent=function(){var n=this.options.onResize,t=this.options.resizeMessage;this.$.on("mousedown",".resize-handle",function(i){var s=e(this).parent().addClass("resizing"),o=s.closest(".row"),r=i.pageX,d=s.width(),l=o.width(),h=a.round(12*d/l),p=h;s.attr("data-grid",h);var g=function(n){var i=n.pageX,o=a.max(1,a.min(12,a.round(12*(d+(i-r))/l)));p!=o&&(s.attr("data-grid",o).css("width",100*o/12+"%"),t&&e.zui.messager&&e.zui.messager.show(a.round(100*o/12)+"% ("+o+"/12)",{scale:!1,placement:"center",icon:"resize-h",fade:!1,close:!1}),p=o),n.preventDefault(),n.stopPropagation()},c=function(i){e.zui.messager&&e.zui.messager.hide(),s.removeClass("resizing");var o=s.attr("data-grid");if(h!=o&&e.isFunction(n)){var r=function(){s.attr("data-grid",h).css("width",null)},d=n({element:s,old:h,grid:o,revert:r});d===!1?r():d!==!0&&t&&e.zui.messager&&e.zui.messager.success(a.round(100*o/12)+"% ("+o+"/12)",{placement:"center",time:1e3,close:!1})}e("body").off("mousemove.resize",g).off("mouseup.resize",c),i.preventDefault(),i.stopPropagation()};e("body").on("mousemove.resize",g).on("mouseup.resize",c),i.preventDefault(),i.stopPropagation()}).children(".row").children(":not(.dragging-col-holder)").append('<div class="resize-handle"><i class="icon icon-resize-h"></i></div>')},s.prototype.refresh=function(a,n){var t=this.options.afterRefresh;a=e(a);var i=a.data("url");i&&(a.addClass("panel-loading").find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").addClass("icon-spin"),e.ajax({url:i,dataType:"html"}).done(function(i){var s=e(i);s.hasClass("panel")?a.empty().append(s.children()):n?a.find(".panel-body").empty().html(i):a.html(i),e.isFunction(t)&&t.call(this,{result:!0,data:i})}).fail(function(){a.addClass("panel-error"),e.isFunction(t)&&t.call(this,{result:!1})}).always(function(){a.removeClass("panel-loading"),a.find(".panel-heading .icon-refresh,.panel-heading .icon-repeat").removeClass("icon-spin")}))},s.prototype.init=function(){var a=this.options,n=this;if(a.data){var t=e('<div class="row"/>');e.each(a.data,function(a,n){var i=e('<div class="col-sm-'+(n.colWidth||4)+'"/>',n.colAttrs),s=e('<div class="panel" data-id="'+(n.id||e.zui.uuid())+'"/>',n.panelAttrs);if(void 0!==n.content)if(e.isFunction(n.content)){var o=n.content(s);o!==!0&&s.html(o)}else s.html(n.content);t.append(i.append(s.data("url",n.url)))}),n.$.append(t)}n.handlePanelHeight(),n.handlePanelPadding(),n.handleRemoveEvent(),n.handleRefreshEvent(),a.resizable&&n.handleResizeEvent(),n.draggable&&n.handleDraggable();var i=0;n.$.find(".panel").each(function(){var t=e(this);t.data("order",++i),t.attr("id")||t.attr("id","panel"+i),t.attr("data-id")||t.attr("data-id",i),n.refresh(t,a.onlyRefreshBody)})},e.fn.dashboard=function(a){return this.each(function(){var n=e(this),t=n.data("zui.dashboard"),i="object"==typeof a&&a;t||n.data("zui.dashboard",t=new s(this,i)),"string"==typeof a&&t[a]()})},e.fn.dashboard.Constructor=s}(jQuery,Math);