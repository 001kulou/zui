/*!
 * ZUI: 拖放 - v1.4.0 - 2016-08-17
 * http://zui.sexy
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2016 cnezsoft.com; Licensed MIT
 */
!function(t,e,o){"use strict";var n=function(e,o){this.$=t(e),this.options=this.getOptions(o),this.init()};n.DEFAULTS={container:"body",deviation:5,sensorOffsetX:0,sensorOffsetY:0},n.prototype.getOptions=function(e){return e=t.extend({},n.DEFAULTS,this.$.data(),e)},n.prototype.callEvent=function(e,o){return t.zui.callEvent(this.options[e],o,this)},n.prototype.init=function(){this.handleMouseEvents()},n.prototype.handleMouseEvents=function(){var n=this.$,s=this,i=this.options,l="before";this.$triggerTarget=i.trigger?(t.isFunction(i.trigger)?i.trigger(n):n.find(i.trigger)).first():n,this.$triggerTarget.on("mousedown",function(r){function a(e){var l={left:e.pageX,top:e.pageY};if(!(o.abs(l.left-C.left)<i.deviation&&o.abs(l.top-C.top)<i.deviation)){if(null===g){var r=c.css("position");"absolute"!=r&&"relative"!=r&&"fixed"!=r&&(u=r,c.css("position","relative")),g=n.clone().removeClass("drag-from").addClass("drag-shadow").css({position:"absolute",width:n.outerWidth(),transition:"none"}).appendTo(c),n.addClass("dragging"),s.callEvent("start",{event:e,element:n})}var a={left:l.left-y.left,top:l.top-y.top},f={left:a.left-E.left,top:a.top-E.top};g.css(f),O.left=l.left,O.top=l.top;var p=!1;h=!1,i.flex||d.removeClass("drop-to");var b=null;if(d.each(function(){var e=t(this),o=e.offset(),n=e.outerWidth(),s=e.outerHeight(),r=o.left+i.sensorOffsetX,a=o.top+i.sensorOffsetY;return l.left>r&&l.top>a&&l.left<r+n&&l.top<a+s&&(b&&b.removeClass("drop-to"),b=e,!i.nested)?!1:void 0}),b){h=!0;var w=b.data("id");n.data("id")!=w&&(m=!1),(null===v||v.data("id")!==w&&!m)&&(p=!0),v=b,i.flex&&d.removeClass("drop-to"),v.addClass("drop-to")}i.flex?null!==v&&v.length&&(h=!0):(n.toggleClass("drop-in",h),g.toggleClass("drop-in",h)),s.callEvent("drag",{event:e,isIn:h,target:v,element:n,isNew:p,selfTarget:m,clickOffset:y,offset:a,position:{left:a.left-E.left,top:a.top-E.top},mouseOffset:l}),e.preventDefault()}}function f(o){if(u&&c.css("position",u),null===g)return n.removeClass("drag-from"),t(e).unbind("mousemove",a).unbind("mouseup",f),void s.callEvent("always",{event:o,cancel:!0});h||(v=null);var i=!0,l={left:o.pageX,top:o.pageY},r={left:l.left-y.left,top:l.top-y.top},p={left:l.left-O.left,top:l.top-O.top};O.left=l.left,O.top=l.top;var b={event:o,isIn:h,target:v,element:n,isNew:!m&&null!==v,selfTarget:m,offset:r,mouseOffset:l,position:{left:r.left-E.left,top:r.top-E.top},lastMouseOffset:O,moveOffset:p};i=s.callEvent("beforeDrop",b),i&&h&&s.callEvent("drop",b),t(e).unbind("mousemove",a).unbind("mouseup",f),d.removeClass("drop-to"),n.removeClass("dragging").removeClass("drag-from"),g.remove(),s.callEvent("finish",b),s.callEvent("always",b),o.preventDefault()}if(i.hasOwnProperty(l)&&t.isFunction(i[l])){var p=i[l]({event:r,element:n});if(void 0!==p&&!p)return}var u,d=t.isFunction(i.target)?i.target(n):t(i.target),v=null,g=null,c=t(i.container).first(),h=!1,m=!0,b=n.offset(),C={left:r.pageX,top:r.pageY},E=c.offset(),y={left:C.left-b.left,top:C.top-b.top},O={left:C.left,top:C.top};n.addClass("drag-from"),t(e).bind("mousemove",a).bind("mouseup",f),r.preventDefault()})},n.prototype.reset=function(){this.$triggerTarget.off("mousedown"),this.handleMouseEvents()},t.fn.droppable=function(e){return this.each(function(){var o=t(this),s=o.data("zui.droppable"),i="object"==typeof e&&e;s||o.data("zui.droppable",s=new n(this,i)),"string"==typeof e&&s[e]()})},t.fn.droppable.Constructor=n}(jQuery,document,Math);